---
sidebar_position: 6
title: "CP 6"
description: "Synth√®se de la CP 6 \"D√©velopper des composants d'acc√®s aux donn√©es SQL et NoSQL\" du titre professionnel D√©veloppeur Web et Web Mobile (DWWM TP-01280m04)."
tags:
  - DWWM
  - Base de donn√©es
  - SQL
  - Back-end
  - ORM/ODM
  - S√©curit√©
  - Chiffrement
  - Hachage
---

import Admonition from "@theme/Admonition";
import TabItem from "@theme/TabItem";
import Tabs from "@theme/Tabs";

# D√©velopper des composants d'acc√®s aux donn√©es SQL et NoSQL

## üìö R√©f√©rences

- REAC _(mise √† jour du 03/07/2024)_, pages 25 et 26
- RE _(mise √† jour du 03/07/2024)_, page 11

## üìã En r√©sum√©

Gros morceau la cr√©ation de bases de donn√©es, n'est-ce pas ? üòÖ  
On va pouvoir souffler un coup en parlant maintenant de l'acc√®s √† ces bases de donn√©es. _(enfin, souffler... pas trop quand m√™me)_

Et tu sais quoi, comme tout ce qu'on a vu jusqu'√† maintenant, on va all√©ger un peu les choses en parlant de merveilleux outils comme les **ORM** et les **ODM** !

<details>
  <summary>C'est quoi un ORM et ODM ? Quelles sont les diff√©rences ?</summary>

  Les ORM _(Object-Relational Mapping)_ et les ODM _(Object-Document Mapper)_ sont des outils qui permettent de faire le lien entre les bases de donn√©es et les langages de programmation.

  - Les ORM sont utilis√©s pour les bases de donn√©es relationnelles, comme MySQL, PostgreSQL ou SQLite. Ils permettent de manipuler les donn√©es de la base de donn√©es sous forme d'objets, ce qui facilite leur utilisation dans le code.
  - Les ODM sont utilis√©s pour les bases de donn√©es NoSQL, comme MongoDB. Ils fonctionnent de la m√™me mani√®re que les ORM, mais pour les bases de donn√©es NoSQL.

  En gros, les ORM et les ODM permettent de simplifier la manipulation des donn√©es dans le code, en √©vitant d'avoir √† √©crire des requ√™tes √† la main.
</details>

Alleeeez, on va voir √ßa de plus pr√®s ! üòé

## ‚öôÔ∏è Configuration d'un ORM

<Tabs>
  <TabItem value="Prisma" label="NodeJS + Prisma">
    Pour ce qui est de l'ORM, on va parler de Prisma ! Bien entendu, mis √† part la
    syntaxe, les principes restent les m√™mes pour les autres ORM.

    <details>
      <summary>C'est quoi Prisma ?</summary>

      Prisma est un ORM qui permet de simplifier la manipulation des bases de donn√©es relationnelles. Il permet de g√©n√©rer du code √† partir du sch√©ma de la base de donn√©es, ce qui facilite la manipulation des donn√©es dans le code.

      Prisma est compatible avec plusieurs bases de donn√©es relationnelles, comme MySQL, PostgreSQL ou SQLite ainsi que MongoDB pour les bases de donn√©es NoSQL.
    </details>

    Dans un premier temps, on va installer Prisma et configurer notre base de donn√©es.

    <details>
      <summary>Installation de Prisma</summary>

      ```bash
      npm install prisma --save-dev # Installation de Prisma
      npx prisma init # Initialisation de Prisma dans le projet
      ```

      Une fois Prisma install√© et initialis√©, on va pouvoir le configurer _(ce qui correspond en partie √† la CP 5)_ :

      - Modifier le fichier `.env` √† la racine du projet pour y ajouter les informations de connexion √† la base de donn√©es
      - Cr√©er les mod√®les de donn√©es dans le dossier `prisma/schema.prisma`

      <Tabs>
        <TabItem value="prisma-.env" label="Fichier .env">
          ```env
          DATABASE_URL="postgresql://username:password@localhost:5432/database?schema=public"
          ```
        </TabItem>

        <TabItem value="prisma-prisma.schema" label="Fichier prisma.schema">
          ```prisma
          datasource db {
            provider = "postgresql"
            url      = env("DATABASE_URL")
          }

          generator client {
            provider = "prisma-client-js"
          }

          model User {
            id Int @id @default(autoincrement())
            email String @unique
            password String
          }
          ```
        </TabItem>
      </Tabs>
    </details>
  </TabItem>

  <TabItem value="Laravel" label="PHP + Laravel">
    R√©daction √† faire

    Voir la documentation officielle de Laravel, pour la cr√©ation de migrations et de mod√®les avec [Eloquent](https://laravel.com/docs/master/eloquent).
  </TabItem>

  <TabItem value="Symfony" label="PHP + Symfony">
    R√©daction √† faire

    Voir la documentation officielle de Symfony, pour la cr√©ation de migrations et de mod√®les avec [Doctrine](https://symfony.com/doc/current/doctrine.html).
  </TabItem>
</Tabs>

<details>
  <summary>Je fais mes requ√™tes SQL √† la main, il faut que j'apprenne √† utiliser un ORM/ODM ?</summary>

  **Non** !

  D'un certain c√¥t√©, c'est nettement plus int√©ressant de savoir r√©aliser les requ√™tes par toi-m√™me, sans utiliser d'outils qui g√©n√®rent du SQL √† ta place.

  En entreprise, tu vas certainement utiliser ces fameux outils, mais d√®s que l'on va chercher √† avoir les requ√™tes les plus optimis√©es possibles, il va falloir mettre les mains dans le cambouis !
</details>

Mais avant de vouloir manipuler nos donn√©es, on va s'assurer d'une chose primordiale : l'**int√©grit√© des donn√©es**.

## üîé Int√©grit√© des donn√©es

L'int√©grit√© des donn√©es, c'est le fait de garantir que les donn√©es stock√©es dans la base de donn√©es sont correctes et coh√©rentes, de la cr√©ation jusqu'√† la suppression.
Si dans un champ de ta base de donn√©es tu attends un nombre entier, tu ne vas pas accepter une cha√Æne de caract√®res, n'est-ce pas ?

Et pour garantir cette int√©grit√©, on va mettre en place des v√©rifications **avant** d'ins√©rer ou de mettre √† jour des donn√©es dans la base de donn√©es.

Rien de plus simple bien entendu !

Tu t'attends √† avoir une adresse email dans un champ ?  
Alors tu vas v√©rifier que l'adresse email est bien une adresse email, et non pas une cha√Æne de caract√®res lambda.

<Tabs>
  <TabItem value="node-joi" label="JOI (Node.js)">
    ```typescript
    import type { Request, Response } from 'express';

    import { user } from '@/services';
    import Joi from 'joi';

    const userController = {
      // ...

      async updateEmail(req: Request, res: Response) {
        const schema = Joi.object({
          email: Joi.string().email().required(),
        });

        const { error } = schema.validate(req.body);

        if (error) {
          // L'email n'est pas valide :
          // On retourne une erreur 400 avec le message d'erreur g√©n√©r√© par JOI
          return res.status(400).json({ error: error.details[0].message });
        }

        // L'email est valide :
        // 1. On modifie l'email de l'utilisateur actuellement connect√© (ID stock√© en session) via notre service `user`
        await user.updateEmail(req.session.userId, req.body.email);

        // 2. On retourne une r√©ponse 200 avec un message de succ√®s
        return res.status(200).json({ message: 'Email mis √† jour' });
      },
    };
    ```
  </TabItem>

  <TabItem value="php-laravel" label="Laravel (PHP)">
    ```php
    namespace App\Http\Controllers;

    use Illuminate\Http\Request;
    use App\Models\User;
    use Validator;

    class UserController extends Controller
    {
        // ...

        public function updateEmail(Request $request)
        {
            $validator = Validator::make($request->all(), [
                'email' => 'required|email',
            ]);

            if ($validator->fails()) {
                // L'email n'est pas valide :
                // On retourne une erreur 400 avec les erreurs de validation
                return response()->json($validator->errors(), 400);
            }

            // L'email est valide :
            // 1. On modifie l'email de l'utilisateur via notre mod√®le `User`
            User::where('id', auth()->id())->update(['email' => $request->email]);

            // 2. On retourne une r√©ponse 200 avec un message de succ√®s
            return response()->json(['message' => 'Email mis √† jour'], 200);
        }
    }
    ```
  </TabItem>
</Tabs>

## üíº Comp√©tences attendues

Si tu utilises un outil te g√©n√©rant les requ√™tes automatiquement, il est important de savoir reproduire √† la main les requ√™tes g√©n√©r√©es par cet outil.

Cet outil n'a que l'objectif de te faciliter la t√¢che, mais il ne doit pas te dispenser de comprendre ce qu'il se passe derri√®re.  
√Ä toi de montrer √† ton jury que ce qu'il se passe derri√®re n'est pas pure magie ! üòÑ

<details>
  <summary>Voici ce que ~peut~ **va** faire ton jury en cas de doute</summary>

  Si pour ton jury, il reste un doute sur ta compr√©hension des requ√™tes : il peut √™tre amen√© √† tes poser des questions suppl√©mentaires et parfois te demander de reproduire une requ√™te SQL de t√™te.

  Oui, une requ√™te SQL de t√™te ! _(M√™me si tu as utilis√© MongoDB ou une autre base de donn√©es NoSQL)_  
  Alors ne t'inqui√®te pas, de t√™te c'est un sacr√© challenge et ton jury ne va pas t'en vouloir si tu t'emm√™les les pinceaux.

  De mani√®re g√©n√©ral, on √©vite d'aller trop loin et on cherche **uniquemment** la compr√©hension et le placement des mots cl√©s pour une requ√™te avec jointure.

  Par exemple :
  > "Pouvez-vous nous donner la requ√™te SQL pour r√©cup√©rer les pseudos d'utilisateur ayant post√© au minimum 3 articles ?"

  R√©ponse possible :
  ```sql
  SELECT u.pseudo -- S√©lectionne la colonne `pseudo` de la table `utilisateur` (alias√©e `u` dans le `FROM`)
  FROM utilisateur u -- R√©cup√©ration de la table `utilisateur`, alias√©e `u`
  JOIN article a ON u.id = a.utilisateur_id -- Jointure entre `utilisateur` et `article` (alias√©e `a`) sur la colonne `id` de `utilisateur` et `utilisateur_id` de `article`
  GROUP BY u.pseudo -- Regroupe les r√©sultats par `pseudo`
  WHERE COUNT(a.id) >= 3; -- Compte le nombre d'articles par utilisateur et filtre sur ceux ayant post√© au moins 3 articles
  ```

  ... Bon, OK.. cette requ√™te, elle pique un peu plus qu'un simple jointure, √† cause de l'utilisation du `GROUP BY` et du `COUNT`... mais tu vois l'id√©e ! üòÖ

  Dans tous les cas, on ne va pas te demander de reproduire une requ√™te complexe ou d'avoir le niveau d'un DBA _(administrateur de base de donn√©es)_ !
</details>

## üîê Confidentialit√© des donn√©es

La plupart du temps, nos bases de donn√©es vont accueillir des donn√©es confidentielles, comme :

- Des mots de passe
- Des informations personnelles _(nom, pr√©nom, adresse, etc.)_
- Des donn√©es sensibles _(informations bancaires, m√©dicales, etc.)_

Bien que notre bases de donn√©es se doit d'√™tre s√©curis√©e dans son acc√®s et ses permissions, dans le cas d'une fuite il est important de s√©curiser ces donn√©es.

Pour les mots de passe, on va les hacher avant de les stocker dans la base de donn√©es.

<details>
  <summary>C'est quoi le hachage d'un mot de passe ?</summary>

  Le hachage d'un mot de passe est une mani√®re de le s√©curiser en le transformant en une cha√Æne de caract√®res "al√©atoire", appel√©e **hash**.

  Il est important de noter que le hachage est **unidirectionnel**, c'est-√†-dire qu'il est impossible de retrouver le mot de passe d'origine √† partir de son hash contrairement au **chiffrement**.
</details>

<details>
  <summary>Et le chiffrement, √ßa sert √† quoi ?</summary>

  Comme le hachage, le chiffrement permet de s√©curiser des donn√©es. Cependant : le chiffrement est **bidirectionnel**.  
  C'est √† dire que l'on peut retrouver les donn√©es d'origine √† partir des donn√©es chiffr√©es.

  Si tu as d√©j√† eu l'occasion d'envoyer des "messages cod√©s", c'est que tu as d√©j√† utilis√© le chiffrement sans pour autant le savoir !
  L'un des chiffrements les plus connus est le **chiffre de C√©sar**, qui consiste √† d√©caler les lettres de l'alphabet d'un certain nombre de positions.

  Par exemple :

  ```
  Message : "Bonjour"
  D√©calage : 3

  Message chiffr√© : "Erqmrxu"
  ```

  <Admonition type="warning">
    Le chiffrement n'est pas une solution de s√©curit√© absolue, il est possible de retrouver les donn√©es d'origine √† partir des donn√©es chiffr√©es.  
    D'ailleurs le chiffre de C√©sar est un chiffrement tr√®s simple √† casser, on ne va donc pas l'utiliser pour prot√©ger les donn√©es sensibles !
  </Admonition>

  On va privil√©gier un algorithme de chiffrement qui se base sur une **cl√© secr√®te**, qui sera la cl√© pour chiffrer et d√©chiffrer les donn√©es.  
  C'est d'ailleurs plus ou moins ce qui est fait avec la c√©l√®bre [machine Enigma](https://fr.wikipedia.org/wiki/Enigma_(machine)) utilis√©e par les allemands pendant la Seconde Guerre Mondiale pour chiffrer leurs messages et √©viter qu'ils soient intercept√©s et compris par les alli√©s.
</details>

Mais alors, comment on peut s'y prendre ?

ü•Åü•Åü•Å

Avec des biblioth√®ques, tout simplement ! üôÉ  
_(Ou si tu es un peu fou, tu peux essayer de le faire toi-m√™me, mais attention √† ce que ce soit **r√©ellement s√©curis√©** sinon tu en deviens le seul et unique **responsable**)_

Tu as notamment des biblioth√®ques _(Node.js)_ qui sont tr√®s utilis√©es :
- Hachage : `bcrypt` _(ou encore `argon2`)_ 
- Chiffrement : `crypto` _(native √† Node.js en plus, si √ßa c'est pas la classe üòé)_

Je te laisse te plonger dans les documentations associ√©es, que tu retrouveras _(presque)_ tout en bas de cette fiche.

Et naturellement : **PERSONNE** ne doit avoir acc√®s √† ces donn√©es, √† part les personnes autoris√©es/concern√©es bien entendu.

## üéØ Crit√®res d'√©valuation

- Les traitements relatifs aux manipulations des donn√©es r√©pondent aux fonctionnalit√©s d√©crites dans le dossier de conception
- L'int√©grit√© et la confidentialit√© des donn√©es sont maintenues
- Les cas d'exception sont pris en compte
- Toutes les entr√©es sont contr√¥l√©es et valid√©es dans les composants serveurs s√©curis√©s
- Les tests unitaires et de s√©curit√© sont associ√©s √† chaque composant
- La d√©marche structur√©e de r√©solution de probl√®me est adapt√©e en cas de dysfonctionnement
- Le syst√®me de veille permet de suivre les √©volutions technologiques et les probl√©matiques de s√©curit√© li√©es aux bases de donn√©es SQL et NoSQL

## ü§Ø Aller plus loin _(hors r√©f√©rentiel)_

T'es encore l√† ? Tu aimes √ßa les ~patates~ bases de donn√©es, hein ? üòè  
Alors dans ce cas, je te recommande chaudement de te pencher sur PostgreSQL qui est, √† mon sens, l'une des seules **vraies** bases de donn√©es relationnelles.

Je ne m'√©talerai pas sur ce sujet, mais d√©sol√© MySQL/MariaDB de ne pas √™tre au niveau... üòÖ

Les ressources que je m'appr√™te √† te recommander sont un peu plus avanc√©es, mais ce sont d'excellentes portes d'entr√©es vers des m√©tiers comme DBA par exemple.
Tu retrouveras des notions tr√®s bien expliqu√©es et pertinentes pour t'am√©liorer sur le sujet dans les ressources de [Dalibo](https://www.dalibo.com/formations).

<Admonition type="info" title="Gratuit√© des formations Dalibo">
  Dalibo propose des formations, mais qui ne sont pas gratuites pour autant.  
  Seuls les supports de cours sont disponibles gratuitement, aux formats EPUB et PDF.

  Tu peux retrouver ces supports sur la page [Formations](https://www.dalibo.com/formations) du site de Dalibo.
</Admonition>

---

## üß† Documentations

- [SQL.sh - Cours et tutoriels SQL](https://sql.sh/)
- [Prisma - Documentation](https://www.prisma.io/docs/)
- [JOI - Documentation](https://joi.dev/api/?v=17.13.0)
- [Dalibo - Formations](https://www.dalibo.com/formations)
- [Wikip√©dia - Chiffrement de C√©sar](https://fr.wikipedia.org/wiki/Chiffrement_par_d%C3%A9calage)
- [bcrypt - Documentation](https://www.npmjs.com/package/bcrypt)
- [argon2 - Documentation](https://www.npmjs.com/package/argon2)
- [crypto - Documentation](https://nodejs.org/api/crypto.html)
